<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css" />
    <title>履歴書・経歴書作成アプリ</title>
</head>

<body>
    <div class="form-container">
        <a href="index.html">戻る</a>
        <h1>履歴書作成</h1>
        <!-- 個人情報作成欄 -->
        <form id="resumeForm">
            <div class="form-row">
                <!-- 名前（カタカナ）入力欄 -->
                <div class="form-label">
                    <label for="last-name-kana">名前（ひらがな）</label>
                </div>
                <div class="form-input-group">
                    <div class="name-input-wrapper">
                        <label for="last-name-katakana">せい</label>
                        <input type="text" id="last-name-hiragana" name="name"
                            class="textbox address_textbox name_textbox" placeholder="例:やまだ">
                    </div>
                    <div class="name-input-wrapper">
                        <label for="first-name-katakana">めい</label>
                        <input type="text" id="first-name-hiragana" name="name"
                            class="textbox address_textbox name_textbox" placeholder="例:たろう">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <!-- 名前（漢字）入力欄 -->
                <div class="form-label">
                    <label for="last-name">名前（漢字）</label>
                </div>
                <div class="form-input-group">
                    <div class="name-input-wrapper">
                        <label for="last-name-kanzi">姓</label>
                        <input type="text" id="last-name-kanzi" name="name" class="textbox address_textbox name_textbox"
                            placeholder="例:山田">
                    </div>
                    <div class="name-input-wrapper">
                        <label for="first-name-kanzi">名</label>
                        <input type="text" id="first-name-kanzi" name="name"
                            class="textbox address_textbox name_textbox" placeholder="例:太郎">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <!-- 生年月日欄 -->
                <div class="form-label">
                    <label for="birth">生年月日</label>
                </div>
                <div class="form-input-group">
                    <input type="date" id="birth_date" value="2017-06-01">
                </div>
            </div>
            <div class="form-row">
                <!-- 性別選択欄 -->
                <div class="form-label">
                    <label for="gender">性別</label>
                </div>
                <div class="form-input-group">
                    <input type="radio" name="gender" value="男性"> 男性
                    <input type="radio" name="gender" value="女性" checked> 女性
                </div>
            </div>
            <div class="form-row">
                <!-- 住所入力欄 -->
                <div class="form-label">
                    <label for="address">住所</label>
                </div>
                <div class="form-input-group">
                    <label for="searchAddressBox">〒
                        <input type="number" id="searchAddressBox" class="textbox address_textbox"
                            placeholder="例:1638001(ﾊｲﾌﾝなし)" onkeyup="inputAddressCheck ()">
                    </label>
                    <button type="button" onclick="searchAddress()">探す</button>
                </div>
                <div id="checkAddress"></div>
                <div class="form-input-group">
                    <label for="address_hiragana">住所(ひらがな)
                        <input type="text" id="address_hiragana" class="textbox" placeholder="例:まつえしとのまち">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="banti_hiragana">番地(ひらがな)
                        <input type="text" class="textbox" id="banti_hiragana" placeholder="例:１ばんち">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="address">住所
                        <input type="text" id="addressForm" class="textbox" placeholder="例:松江市殿町">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="banti">番地
                        <input type="text" class="textbox" id="banti" placeholder="例:１番地">
                    </label>
                </div>
            </div>
            <div class="form-row">
                <!-- 電話番号入力欄 -->
                <div class="form-label">
                    <label for="searchTelBox">電話番号</label>
                </div>
                <div class="form-input-group">
                    <input type="number" id="searchTelBox" name="tell" class="textbox" placeholder="例:0123456789"
                        onkeyup="inputTelCheck ()">
                </div>
                <div id="checkTel"></div>
            </div>
            <div class="form-row">
                <!-- メールアドレス入力欄 -->
                <div class="form-label">
                    <label for="searchMailBox">メールアドレス</label>
                </div>
                <div class="form-input-group">
                    <input type="mail" id="searchMailBox" name="email" class="textbox" placeholder="例:sample@co.jp"
                        onkeyup="inputMailCheck ()">
                </div>
                <div id="checkMail"></div>
            </div>
            <div class="form-row">
                <!-- 緊急連絡先住所入力欄 -->
                <div class="form-label">
                    <label for="address">緊急連絡先住所</label>
                </div>
                <div class="form-input-group">
                    <label for="searchAddressBox">〒
                        <input type="number" id="searchAddressBox_kinkyu" class="textbox address_textbox"
                            placeholder="例:1638001(ﾊｲﾌﾝなし)" onkeyup="inputAddressCheck ()">
                    </label>
                    <button type="button" onclick="searchAddress_kinkyu()">探す</button>
                </div>
                <div id="checkAddress_kinkyu"></div>
                <div class="form-input-group">
                    <label for="address_hiragana">緊急連絡先住所(ひらがな)
                        <input type="text" id="address_hiragana_kinkyu" class="textbox" placeholder="例:まつえしとのまち">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="banti_hiragana">緊急連絡先番地(ひらがな)
                        <input type="text" class="textbox" id="banti_hiragana_kinkyu" placeholder="例:１ばんち">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="address">緊急連絡先住所
                        <input type="text" id="addressForm_kinkyu" class="textbox" placeholder="例:松江市殿町">
                    </label>
                </div>
                <div class="form-input-group">
                    <label for="banti">緊急連絡先番地
                        <input type="text" class="textbox" id="banti_kinkyu" placeholder="例:１番地">
                    </label>
                </div>
            </div>
            <div class="form-row">
                <!-- 緊急連絡先電話番号入力欄 -->
                <div class="form-label">
                    <label for="searchTelBox_kinkyu">緊急連絡先電話番号</label>
                </div>
                <div class="form-input-group">
                    <input type="number" id="searchTelBox_kinkyu" name="tell" class="textbox" placeholder="例:0123456789"
                        onkeyup="inputTelCheck ()">
                </div>
                <div id="checkTel_kinkyu"></div>
            </div>
            <div class="form-row">
                <!-- 緊急連絡先メールアドレス入力欄 -->
                <div class="form-label">
                    <label for="searchMailBox_kinkyu">緊急連絡先メールアドレス</label>
                </div>
                <div class="form-input-group">
                    <input type="mail" id="searchMailBox_kinkyu" name="email" class="textbox"
                        placeholder="例:sample@co.jp" onkeyup="inputMailCheck ()">
                </div>
                <div id="checkMail_kinkyu"></div>
            </div>
            <!-- 写真アップロード欄 -->
            <div class="form-row">
                <input id="imageInput" type="file" accept="image/*">
                <br>
                <img id="preview" alt="プレビュー" style="display: none;">
            </div>

            <!-- 学歴欄作成欄 -->
            <h2>学歴</h2>
            <div id="educationList">
                <!-- 学校名入力欄 -->
                <label for="school_name">学校名</label>
                <input type="text" id="school_name" name="school_name" class="textbox" placeholder="例:〇〇学校"></br>
                <!-- 学部学科名入力欄 -->
                <label for="major_name">学部学科名</label>
                <input type="text" id="major_name" name="major_name" class="textbox" placeholder="例:〇〇学部　〇〇学科"></br>
                <!-- 入学年月選択欄 -->
                <label for="school_enroll">入学年月</label>
                <input type="date" /></br>
                <!-- 卒業年月選択欄 -->
                <label for="school_enroll">卒業年月</label>
                <input type="date" /></br>
                <label for="educationNote">備考</label>
                <input type="text" class="textbox" name="educationNote[]" placeholder="例：中退など" />
            </div>
            <div>
                <button type="button" class="btn-add" onclick="addEducationItem()">
                    入力欄を増やす
                </button>
            </div>

            <!-- 職歴欄作成欄 -->
            <h2>職歴</h2>
            <div id="workList">
                <!-- 会社名入力欄 -->
                <label for="company_name">会社名</label>
                <input type="text" id="company_name" name="company_name" class="textbox" placeholder="例:〇〇株式会社"></br>
                <!-- 部署名入力欄 -->
                <label for="branch_name">部署名</label>
                <input type="text" id="branch_name" name="branch_name" class="textbox" placeholder="例:〇〇部"></br>
                <!-- 入社年月選択欄 -->
                <label for="company_enroll">入社年月</label>
                <input type="date" /></br>
                <!-- 退社年月選択欄 -->
                <label for="company_enroll">退社年月</label>
                <input type="date" /></br>
                <label for="workNote">備考</label>
                <input type="text" class="textbox" name="workNote[]" placeholder="例：転籍など" />
            </div>
            <div>
                <button type="button" class="btn-add" onclick="addWorkItem()">
                    入力欄を増やす
                </button>
            </div>

            <!-- 資格など欄作成欄 -->
            <h2>資格・免許</h2>
            <div id="CertificationList">
                <!-- 資格などの名前入力欄 -->
                <label for="Certification_name">資格・免許名</label>
                <input type="text" id="Certification_name" name="Certification_name" class="textbox"
                    placeholder="例:〇〇検定"></br>
                <!-- 取得／合格年月選択欄 -->
                <label for="Certification_enroll">取得年月</label>
                <input type="date" /></br>
                <label for="CertificationNote">備考</label>
                <input type="text" class="textbox" name="certificationNote[]" placeholder="例：合格、取得など" />
            </div>
            <div>
                <button type="button" class="btn-add" onclick="addCertificationItem()">
                    入力欄を増やす
                </button>
            </div>

            <!-- 志望動機など作成欄 -->
            <h2>志望動機・特技・好きな学科・アピールポイントなど</h2>
            <div>
                <!-- 志望動機など入力欄 -->
                <textarea id="Motivation" name="Motivation" class="textarea" rows="7" cols="50"></textarea></br>
            </div>

            <!-- 本人希望など作成欄 -->
            <h2>本人希望記入欄</h2>
            <div>
                <!-- 志望動機など入力欄 -->
                <textarea id="wish" name="wish" class="textarea" rows="7" cols="50"></textarea></br></br>
            </div>

            <!-- csv出力ボタン -->
            <button type="button" onclick="exportCSV()">出力する</button>
        </form>
    </div>

    <script src="script.js"></script>
    <script>
        // 画像取得
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');

        imageInput.addEventListener('change', function (e) {
            const file = e.target.files[0];

            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };

                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        // 現在時点での誕生日を取得
        function formatDateToJapanese(dateString) {
            const date = new Date(dateString);
            const current_date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const age = current_date.getFullYear() - year;

            return `${year}年　　${month}月　　${day}日生　　（満${age}歳）`;
        }

        // 現在時点の年月日を取得
        function getCurrentDate() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            return `${year}年　　${month}月　　${day}日現在`;
        }

        // csv出力
        async function exportCSV() {
            // フォームのデフォルト動作を防ぐ
            event.preventDefault();

            const current_date_value = getCurrentDate();

            const name_hiragana_value =
                document.getElementById('last-name-hiragana').value + " " +
                document.getElementById('first-name-hiragana').value;

            const name_kanji_value =
                document.getElementById('last-name-kanzi').value + " " +
                document.getElementById('first-name-kanzi').value;

            const birth_date_value =
                document.getElementById('birth_date').value;

            const birth_value = formatDateToJapanese(birth_date_value);

            const gender_value = document.querySelector('input[name="gender"]:checked');

            const address_postcode_value = "現住所 〒" + document.getElementById('searchAddressBox').value.slice(0, 3) + '-' + document.getElementById('searchAddressBox').value.slice(-4);
            const address_value = document.getElementById('addressForm').value + document.getElementById('banti').value;
            const address_hiragana_value = document.getElementById('address_hiragana').value + document.getElementById('banti_hiragana').value;

            const tel_value = "電話" + document.getElementById('searchTelBox').value;

            const email_value = "E-mail" + "\n\n" + document.getElementById('searchMailBox').value;

            const emergency_address_postcode_value = "現住所 〒" + document.getElementById('searchAddressBox_kinkyu').value.slice(0, 3) + '-' + document.getElementById('searchAddressBox_kinkyu').value.slice(-4) + "     （現住所以外に連絡を希望する場合のみ記入）";
            const emergency_address_value = document.getElementById('addressForm_kinkyu').value + document.getElementById('banti_kinkyu').value;
            const emergency_address_hiragana_value = document.getElementById('address_hiragana_kinkyu').value + document.getElementById('banti_hiragana_kinkyu').value;

            const emergency_tel_value = "電話" + document.getElementById('searchTelBox_kinkyu').value;

            const emergency_email_value = "E-mail" + "\n\n" + document.getElementById('searchMailBox_kinkyu').value;

            try {
                const writeResponse = await fetch('/api/write-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_date_value: current_date_value,
                        name_hiragana: name_hiragana_value,
                        name_kanji: name_kanji_value,
                        birth_value: birth_value,
                        gender_value: gender_value.value,
                        address_postcode_value: address_postcode_value,
                        address_value: address_value,
                        address_hiragana_value: address_hiragana_value,
                        tel_value: tel_value,
                        email_value: email_value,
                        filename: '履歴書.xlsx',
                        emergency_address_postcode_value: emergency_address_postcode_value,
                        emergency_address_value: emergency_address_value,
                        emergency_address_hiragana_value: emergency_address_hiragana_value,
                        emergency_tel_value: emergency_tel_value,
                        emergency_email_value: emergency_email_value
                    })
                });

                const writeResult = await writeResponse.json();

                if (writeResult.success) {
                    window.location.href = `/api/download/${writeResult.filename}`;
                } else {
                    alert('エラーが発生しました: ' + writeResult.error);
                }

            } catch (error) {
                console.error(error);
                alert('エラーが発生しました');
            }
        }
    </script>
</body>

</html>